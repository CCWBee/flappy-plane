<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#1e3a5f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TU-95</title>
  <link rel="manifest" href="../manifest.json">
  <link rel="apple-touch-icon" href="../icons/icon-192.png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{width:100%;height:100%;overflow:hidden;background:#2a4a6b;touch-action:none;-webkit-tap-highlight-color:transparent;user-select:none}
    canvas{display:block;width:100%;height:100%}
    #rot{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#1a1a2e;color:#fff;font-family:Arial,sans-serif;justify-content:center;align-items:center;flex-direction:column;z-index:999;text-align:center;padding:20px}
    #rot .ic{font-size:60px;margin-bottom:16px}
    #rot p{font-size:18px;opacity:.8}
    @media(orientation:portrait)and (max-width:600px){#rot{display:flex}}
  </style>
</head>
<body>
<div id="rot"><div class="ic">&#128260;</div><p>Rotate your device to landscape</p></div>
<canvas id="g"></canvas>
<script>
'use strict';
const canvas=document.getElementById('g'),ctx=canvas.getContext('2d');

function resize(){const d=window.devicePixelRatio||1;canvas.width=window.innerWidth*d;canvas.height=window.innerHeight*d;ctx.setTransform(d,0,0,d,0,0)}
resize();window.addEventListener('resize',resize);
function W(){return window.innerWidth}
function H(){return window.innerHeight}

// ===== DYNAMIC SCALE =====
// PPM scales with screen so you always see ~500m of world width
function PPM(){return Math.max(1,W()/500)}
// Ground horizon sits at 82% of screen height for maximum sky
const HORIZON=0.82;

// ===== CONSTANTS =====
const GRAVITY=9.8,MAX_THRUST=20,LIFT_COEFF=0.04,DRAG_COEFF=0.002,
  PITCH_SPEED=1.8,STALL_SPEED=28,MAX_AOA=0.35,MAX_SPEED=120,
  FLAP_LIFT=[1,1.6,2.2],FLAP_DRAG=[1,1.3,1.8],
  GEAR_DRAG=0.001,FUEL_BURN=0.06,FLAP_NAMES=['UP','T/O','LDG'];

// ===== STATES =====
const ST={MENU:0,BRIEF:1,PLAY:2,CRASH:3,DEBRIEF:4,PAUSE:5};
let state=ST.MENU,missionIdx=0,gameTime=0,frameCount=0,lastTime=0;

// Progress
let prog=JSON.parse(localStorage.getItem('tu95_prog')||'{"u":1,"s":{}}');
function saveProg(){localStorage.setItem('tu95_prog',JSON.stringify(prog))}

// ===== PLANE =====
let P={};
function resetPlane(m){
  P={x:m.sr.x+50,y:m.sr.y,vx:0,vy:0,
    pitch:0,pi:0,throttle:0,fuel:m.fuel||100,
    flaps:0,gear:true,ground:true,groundTime:1,speed:0,crashed:false,landed:null};
}

let cam={x:0,y:0},bombs=[],expl=[],
  rollAcc=0,lastPt=0,rollSt=0,rolls=0,
  objs=[],curObj=0,objDone=0,
  tutMsg='',tutTime=0,tutFired={},
  floats=[],rain=[],gustF=0,gustT=0,
  ltTimer=0,ltFlash=false,turbT=0,
  debData=null;

// ===== MISSIONS =====
const M=[
  {id:1,name:'First Flight',
    brief:'Welcome to the TU-95, comrade! I am Pavel, your instructor. Today you learn to fly. Follow my instructions carefully.',
    terr:[{x:0,y:0},{x:400,y:0},{x:600,y:5},{x:900,y:15},{x:1200,y:10},{x:1500,y:0},{x:2000,y:8},{x:2500,y:20},{x:3000,y:15},{x:3500,y:5},{x:4000,y:0},{x:4500,y:0},{x:5000,y:8},{x:5500,y:15},{x:6000,y:5},{x:6500,y:0},{x:7200,y:0},{x:7500,y:0},{x:8000,y:0}],
    sr:{x:50,ex:350,y:0},er:{x:7200,ex:7500,y:0},wl:8000,fuel:100,
    obj:[{t:'alt',v:150,txt:'Climb to 500 ft'},{t:'wp',x:2500,y:200,txt:'Fly to waypoint A'},{t:'wp',x:5000,y:150,txt:'Fly to waypoint B'},{t:'land',rw:'end',txt:'Land at destination'}],
    tut:true,wx:'clear',par:{t:200,f:35},
    things:[]},
  {id:2,name:'Solo Circuit',
    brief:'Time to fly solo. Take off, follow the waypoints, and land. You know the drill now.',
    terr:[{x:0,y:0},{x:350,y:0},{x:600,y:10},{x:1000,y:30},{x:1400,y:50},{x:1800,y:35},{x:2200,y:15},{x:2800,y:40},{x:3200,y:60},{x:3600,y:45},{x:4000,y:20},{x:4500,y:10},{x:5000,y:0},{x:5500,y:5},{x:6000,y:15},{x:6500,y:5},{x:7000,y:0},{x:7500,y:0},{x:8500,y:0}],
    sr:{x:50,ex:300,y:0},er:{x:7500,ex:7800,y:0},wl:8500,fuel:100,
    obj:[{t:'alt',v:200,txt:'Climb to 650 ft'},{t:'wp',x:2000,y:250,txt:'Waypoint A'},{t:'wp',x:4000,y:200,txt:'Waypoint B'},{t:'wp',x:6000,y:180,txt:'Waypoint C'},{t:'land',rw:'end',txt:'Land at destination'}],
    tut:false,wx:'clear',par:{t:200,f:30},
    things:[{t:'city',x:2500,w:300}]},
  {id:3,name:'Mountain Pass',
    brief:'Mountains ahead. Fly high and watch for wind gusts. The peaks reach over 1300 feet.',
    terr:[{x:0,y:0},{x:350,y:0},{x:700,y:20},{x:1000,y:80},{x:1300,y:200},{x:1600,y:350},{x:1800,y:280},{x:2000,y:150},{x:2300,y:300},{x:2600,y:400},{x:2900,y:320},{x:3200,y:200},{x:3500,y:100},{x:3800,y:50},{x:4200,y:30},{x:4600,y:10},{x:5000,y:0},{x:5500,y:0},{x:6000,y:0}],
    sr:{x:50,ex:300,y:0},er:{x:5500,ex:5800,y:0},wl:6000,fuel:100,
    obj:[{t:'alt',v:400,txt:'Climb above 1300 ft'},{t:'wp',x:1600,y:450,txt:'Clear first peak'},{t:'wp',x:2600,y:500,txt:'Clear highest peak'},{t:'wp',x:4000,y:200,txt:'Past the range'},{t:'land',rw:'end',txt:'Land at mountain base'}],
    tut:false,wx:'windy',par:{t:180,f:30},
    things:[]},
  {id:4,name:'Bombing Run',
    brief:'Three targets marked on the ground. Fly over each and press BOMB. Then return safely.',
    terr:[{x:0,y:0},{x:400,y:0},{x:800,y:10},{x:1200,y:5},{x:1600,y:0},{x:2000,y:8},{x:2400,y:15},{x:2800,y:10},{x:3200,y:5},{x:3600,y:0},{x:4000,y:10},{x:4400,y:20},{x:4800,y:15},{x:5200,y:5},{x:5600,y:0},{x:6000,y:0},{x:6500,y:0},{x:7000,y:0}],
    sr:{x:50,ex:350,y:0},er:{x:6500,ex:6800,y:0},wl:7000,fuel:100,
    obj:[{t:'alt',v:100,txt:'Climb to bombing altitude'},{t:'bomb',x:1800,y:0,r:60,txt:'Bomb target Alpha'},{t:'bomb',x:3400,y:0,r:60,txt:'Bomb target Bravo'},{t:'bomb',x:5000,y:0,r:60,txt:'Bomb target Charlie'},{t:'land',rw:'end',txt:'Return to base'}],
    tut:false,wx:'clear',par:{t:200,f:30},
    things:[{t:'tgt',x:1800,r:60},{t:'tgt',x:3400,r:60},{t:'tgt',x:5000,r:60}]},
  {id:5,name:'Storm Front',
    brief:'Major storm system ahead. Heavy rain, poor visibility, severe turbulence. Keep your nerve.',
    terr:[{x:0,y:0},{x:400,y:0},{x:800,y:15},{x:1200,y:40},{x:1600,y:60},{x:2000,y:45},{x:2400,y:25},{x:2800,y:50},{x:3200,y:70},{x:3600,y:55},{x:4000,y:30},{x:4400,y:15},{x:4800,y:5},{x:5200,y:0},{x:5700,y:0},{x:6200,y:0}],
    sr:{x:50,ex:350,y:0},er:{x:5700,ex:6000,y:0},wl:6200,fuel:100,
    obj:[{t:'alt',v:250,txt:'Climb above 800 ft'},{t:'wp',x:1500,y:300,txt:'Enter the storm'},{t:'wp',x:3000,y:280,txt:'Through the storm'},{t:'wp',x:4500,y:200,txt:'Exit the storm'},{t:'land',rw:'end',txt:'Land in poor visibility'}],
    tut:false,wx:'storm',par:{t:190,f:30},
    things:[]},
  {id:6,name:'Long Haul',
    brief:'Your longest flight. Conserve fuel. You will fly through dusk into night. Bomb two targets en route.',
    terr:[{x:0,y:0},{x:400,y:0},{x:800,y:10},{x:1500,y:30},{x:2200,y:50},{x:3000,y:20},{x:3800,y:0},{x:4500,y:15},{x:5200,y:40},{x:6000,y:80},{x:6800,y:100},{x:7500,y:70},{x:8200,y:30},{x:9000,y:10},{x:10000,y:0},{x:11000,y:5},{x:12000,y:20},{x:13000,y:10},{x:14000,y:0},{x:14500,y:0},{x:15000,y:0}],
    sr:{x:50,ex:350,y:0},er:{x:14500,ex:14800,y:0},wl:15000,fuel:100,
    obj:[{t:'alt',v:200,txt:'Cruising altitude'},{t:'wp',x:3000,y:250,txt:'Checkpoint A'},{t:'bomb',x:5000,y:0,r:70,txt:'Bomb target Alpha'},{t:'wp',x:8000,y:300,txt:'Checkpoint B'},{t:'bomb',x:11000,y:0,r:70,txt:'Bomb target Bravo'},{t:'wp',x:13000,y:150,txt:'Begin descent'},{t:'land',rw:'end',txt:'Land at destination'}],
    tut:false,wx:'night',par:{t:400,f:15},
    things:[{t:'tgt',x:5000,r:70},{t:'tgt',x:11000,r:70},{t:'city',x:3500,w:400},{t:'city',x:9000,w:500},{t:'water',x:6500,ex:7500}]}
];

// ===== TERRAIN =====
function ghAt(x,terr){
  if(x<=terr[0].x)return terr[0].y;
  if(x>=terr[terr.length-1].x)return terr[terr.length-1].y;
  for(let i=0;i<terr.length-1;i++){
    if(x>=terr[i].x&&x<=terr[i+1].x){
      const t=(x-terr[i].x)/(terr[i+1].x-terr[i].x);
      return terr[i].y+t*(terr[i+1].y-terr[i].y);
    }
  }
  return 0;
}
function onRwy(x,rw){return x>=rw.x&&x<=rw.ex}

// ===== WORLD-TO-SCREEN =====
function w2s(wx,wy){
  const p=PPM();
  return{sx:(wx-cam.x)*p+W()/2, sy:H()*HORIZON-(wy-cam.y)*p};
}

// ===== PHYSICS =====
function physics(dt,m){
  if(dt>0.05)dt=0.05;

  // Velocity angle and angle of attack
  const velAng=P.speed>2?Math.atan2(P.vy,P.vx):0;
  let aoa=P.ground?Math.max(0,P.pitch):(P.pitch-velAng);
  // Normalize AoA to [-PI,PI]
  if(aoa>Math.PI)aoa-=2*Math.PI;if(aoa<-Math.PI)aoa+=2*Math.PI;

  // Stall: beyond MAX_AOA, lift drops sharply
  const clampAoA=Math.max(-MAX_AOA,Math.min(MAX_AOA,aoa));
  const stallMul=Math.abs(aoa)>MAX_AOA?0.25:1;

  // Lift: proportional to AoA and speedÂ², perpendicular to velocity
  const cl=LIFT_COEFF*clampAoA*stallMul*FLAP_LIFT[P.flaps];
  const lift=cl*P.speed*P.speed;
  const liftAng=velAng+Math.PI/2;

  // Drag: opposing velocity, with induced drag from AoA
  let dc=DRAG_COEFF*FLAP_DRAG[P.flaps];
  if(P.gear)dc+=GEAR_DRAG;
  dc+=Math.abs(clampAoA)*0.003;
  const drag=dc*P.speed*P.speed;

  // Thrust along pitch direction
  const thrust=MAX_THRUST*P.throttle;

  // Sum forces
  let ax=thrust*Math.cos(P.pitch);
  let ay=thrust*Math.sin(P.pitch)-GRAVITY;

  if(P.speed>1){
    ax+=lift*Math.cos(liftAng)-drag*(P.vx/P.speed);
    ay+=lift*Math.sin(liftAng)-drag*(P.vy/P.speed);
  }

  // Weather
  if(m.wx==='windy'||m.wx==='storm')ay+=gustF;
  if(m.wx==='storm'&&!P.ground){turbT-=dt;if(turbT<=0){turbT=0.5+Math.random()*1.5;P.pi+=(Math.random()-0.5)*0.4}}

  // Ground handling
  if(P.ground){
    P.groundTime+=dt;
    if(P.pitch<0)P.pitch=0;
    // Only allow takeoff after 0.5s on ground (prevents landing bounce)
    if(lift>GRAVITY*1.05&&P.speed>15&&P.groundTime>0.5){
      P.ground=false;P.groundTime=0;P.vy=1.5;P.y+=0.5;
    }else{
      ay=0;P.vy=0;
      if(P.speed>0.5)ax-=3*(P.vx/P.speed);
    }
  }

  // Integration
  P.vx+=ax*dt;P.vy+=ay*dt;P.x+=P.vx*dt;P.y+=P.vy*dt;
  P.speed=Math.sqrt(P.vx*P.vx+P.vy*P.vy);

  // Speed cap
  if(P.speed>MAX_SPEED){const s=MAX_SPEED/P.speed;P.vx*=s;P.vy*=s;P.speed=MAX_SPEED}

  // Pitch
  P.pitch+=P.pi*PITCH_SPEED*dt;
  P.pitch=Math.max(-0.8,Math.min(0.8,P.pitch));

  // Ground collision
  const gh=ghAt(P.x,m.terr);
  if(P.y<=gh){
    const landVy=P.vy; // store before zeroing for landing quality
    const osr=onRwy(P.x,m.sr),oer=onRwy(P.x,m.er);
    if((osr||oer)&&P.gear&&P.vy>-3.5&&Math.abs(P.pitch)<0.35){
      P.y=gh;P.vy=0;
      if(!P.ground)P.groundTime=0; // just touched down
      P.ground=true;
      if(!P.landed&&P.speed<5&&P.x>m.sr.ex)P.landed={vy:landVy,rw:oer?'end':'start'};
    }else if(P.y<gh-0.5||(P.y<=gh&&!P.ground)){crash();return}
    else{P.y=gh;P.vy=0;if(!P.ground)P.groundTime=0;P.ground=true}
  }else P.ground=false;

  if(P.y>800){P.y=800;P.vy=Math.min(P.vy,0)}

  // Fuel
  P.fuel-=P.throttle*FUEL_BURN*dt;
  if(P.fuel<=0){P.fuel=0;P.throttle=0}

  // Barrel roll
  const pd=P.pitch-lastPt;
  if(Math.abs(pd)>0.02&&!P.ground){if(rollAcc===0)rollSt=performance.now();rollAcc+=pd}else rollAcc=0;
  if(Math.abs(rollAcc)>=Math.PI*2){if(performance.now()-rollSt<3000){rolls++;floats.push({txt:'+50 ROLL!',x:P.x,y:P.y+30,l:2})}rollAcc=0}
  lastPt=P.pitch;

  // Bombs
  bombs.forEach(b=>{b.vy-=GRAVITY*dt;b.x+=b.vx*dt;b.y+=b.vy*dt;
    const bg=ghAt(b.x,m.terr);if(b.y<=bg){b.y=bg;b.hit=true;expl.push({x:b.x,y:b.y,l:1})}});
  bombs=bombs.filter(b=>!b.hit);
}

function crash(){P.crashed=true;state=ST.CRASH;expl.push({x:P.x,y:P.y,l:2});setTimeout(()=>{if(state===ST.CRASH)showEnd(false)},2000)}

function dropBomb(){if(P.ground||state!==ST.PLAY)return;bombs.push({x:P.x,y:P.y-5,vx:P.vx,vy:P.vy-2,hit:false})}

// ===== OBJECTIVES =====
function checkObj(m){
  if(curObj>=objs.length)return;
  const o=objs[curObj];let met=false;
  if(o.t==='alt')met=P.y*3.28>=o.v;
  else if(o.t==='wp'){const d=Math.sqrt((P.x-o.x)**2+(P.y-o.y)**2);met=d<60}
  else if(o.t==='land'){if(P.ground&&P.speed<5){met=o.rw==='end'?onRwy(P.x,m.er):onRwy(P.x,m.sr)}}
  else if(o.t==='bomb'){for(const e of expl){const d=Math.sqrt((e.x-o.x)**2+(e.y-(o.y||ghAt(o.x,m.terr)))**2);if(d<o.r){met=true;break}}}
  if(met){curObj++;objDone++;floats.push({txt:'OBJECTIVE COMPLETE',x:P.x,y:P.y+40,l:2});if(curObj>=objs.length)setTimeout(()=>showEnd(true),1500)}
}

// ===== TUTORIAL =====
function checkTut(m){
  if(!m.tut)return;
  const T=[
    {id:'w',c:()=>gameTime<2&&P.throttle===0,m:'PAVEL: Set throttle to 80%. Slide UP on the left bar, or press UP arrow.'},
    {id:'f',c:()=>P.throttle>=0.7&&P.flaps===0&&P.ground,m:'PAVEL: Good! Set flaps to takeoff. Tap the F button or press F.'},
    {id:'r',c:()=>P.flaps===1&&P.speed*1.94>60&&P.ground,m:'PAVEL: Speed is good! Pull nose up gently \u2014 hold the UP pitch button or RIGHT arrow.'},
    {id:'g',c:()=>!P.ground&&P.y<40&&P.gear,m:'PAVEL: Airborne! Retract gear. Tap G button or press G key.'},
    {id:'ff',c:()=>!P.gear&&P.flaps!==0&&P.y>20,m:'PAVEL: Now retract flaps for cruise \u2014 tap F again.'},
    {id:'c',c:()=>P.flaps===0&&!P.gear&&P.y>20&&P.y<130,m:'PAVEL: Excellent! Climb to 500 ft. Keep nose slightly up.'},
    {id:'ww',c:()=>curObj===1&&P.y*3.28>450,m:'PAVEL: Good altitude! Head towards the waypoint diamond ahead.'},
    {id:'d',c:()=>curObj>=3&&P.x>6000,m:'PAVEL: Prepare to land: reduce throttle, deploy gear (G), flaps to landing (F twice).'},
    {id:'l',c:()=>curObj>=3&&P.y<80&&P.x>6500,m:'PAVEL: Line up with the runway. Keep above 60 kts. Gentle descent!'},
  ];
  for(const t of T){if(!tutFired[t.id]&&t.c()){tutFired[t.id]=true;tutMsg=t.m;tutTime=6;break}}
}

// ===== SCORING =====
function calcScore(m,ok){
  let s=0;if(ok)s+=1000;s+=objDone*200;
  let fb=0,tb=0,lb=0;
  if(ok){
    fb=Math.min(300,Math.floor((P.fuel/m.par.f)*300));
    tb=gameTime<=m.par.t?300:Math.floor(300*(m.par.t/gameTime));
    if(P.landed){const v=Math.abs(P.landed.vy);lb=v<1?200:v<2?150:v<3?100:50}
  }
  s+=fb+tb+lb+rolls*50;
  const mx=1000+m.obj.length*200+800;
  const p=s/mx;const st=p>=0.9?3:p>=0.7?2:p>=0.4?1:0;
  return{s,st,fb,tb,lb,rb:rolls*50,ok};
}

function showEnd(ok){
  const m=M[missionIdx];debData=calcScore(m,ok);state=ST.DEBRIEF;
  if(ok){
    if(!prog.s[m.id]||prog.s[m.id].s<debData.s)prog.s[m.id]={s:debData.s,st:debData.st};
    if(missionIdx+2>prog.u)prog.u=Math.min(M.length,missionIdx+2);
    saveProg();
  }
}

// ===== INPUT =====
const keys={};const ptrs=new Map();
let tPU=false,tPD=false;

document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(e.code==='KeyF')cycFlaps();
  if(e.code==='KeyG')togGear();
  if(e.code==='KeyB')dropBomb();
  if(e.code==='KeyP'||e.code==='Escape')togPause();
  if(e.code==='Space'||e.code==='Enter')confirm();
  e.preventDefault();
});
document.addEventListener('keyup',e=>{keys[e.code]=false});

canvas.addEventListener('pointerdown',e=>{e.preventDefault();const z=zone(e.clientX,e.clientY);ptrs.set(e.pointerId,{z,x:e.clientX,y:e.clientY});tStart(z,e)});
canvas.addEventListener('pointermove',e=>{e.preventDefault();const i=ptrs.get(e.pointerId);if(i)tMove(i.z,e)});
canvas.addEventListener('pointerup',e=>{const i=ptrs.get(e.pointerId);if(i)tEnd(i.z);ptrs.delete(e.pointerId)});
canvas.addEventListener('pointercancel',e=>{const i=ptrs.get(e.pointerId);if(i)tEnd(i.z);ptrs.delete(e.pointerId)});

const Z={NONE:0,THR:1,PU:2,PD:3,FL:4,GR:5,BM:6,UI:7};

function zone(cx,cy){
  const w=W(),h=H();
  if(state!==ST.PLAY&&state!==ST.PAUSE)return Z.UI;
  // Throttle: left 50px strip
  if(cx<50)return Z.THR;
  // Must match drawBtns exactly
  const pad=6;
  const bS=Math.min(52,h*0.15);
  // Pitch buttons - bottom right
  const puX=w-pad-bS,puY=h-pad-bS;
  const pdX=w-pad-bS*2-4,pdY=puY;
  if(cy>pdY&&cx>pdX){return cx>puX?Z.PU:Z.PD}
  // F/G/B: bottom-left pills
  const sW=Math.min(40,bS*0.78),sH=Math.min(36,bS*0.7);
  const sY=h-pad-sH;
  if(cy>sY&&cx>=48){
    if(cx<48+sW+2)return Z.FL;
    if(cx<48+(sW+3)*2)return Z.GR;
    if(cx<48+(sW+3)*3)return Z.BM;
  }
  // Pause: top-right
  if(cx>w-44&&cy<36)return Z.UI;
  return Z.NONE;
}

function tStart(z,e){
  if(z===Z.PU)tPU=true;if(z===Z.PD)tPD=true;
  if(z===Z.FL)cycFlaps();if(z===Z.GR)togGear();if(z===Z.BM)dropBomb();
  if(z===Z.THR)updThr(e.clientY);
  if(z===Z.UI)uiTap(e.clientX,e.clientY);
}
function tMove(z,e){if(z===Z.THR)updThr(e.clientY)}
function tEnd(z){if(z===Z.PU)tPU=false;if(z===Z.PD)tPD=false}

function updThr(cy){
  if(state!==ST.PLAY)return;
  const mg=30,range=H()-mg*2;
  P.throttle=Math.round((1-Math.max(0,Math.min(1,(cy-mg)/range)))*20)/20;
}
function cycFlaps(){if(state===ST.PLAY)P.flaps=(P.flaps+1)%3}
function togGear(){if(state===ST.PLAY)P.gear=!P.gear}
function togPause(){if(state===ST.PLAY)state=ST.PAUSE;else if(state===ST.PAUSE)state=ST.PLAY}
function confirm(){
  if(state===ST.BRIEF)startPlay();
  if(state===ST.DEBRIEF)state=ST.MENU;
}
function uiTap(cx,cy){
  const w=W(),h=H();
  if(state===ST.MENU){
    if(cx<110&&cy<42){window.location.href='../';return}
    const lx=w/2-140,lw=280;
    for(let i=0;i<M.length;i++){const ly=88+i*50;if(cx>lx&&cx<lx+lw&&cy>ly&&cy<ly+44&&i<prog.u){missionIdx=i;state=ST.BRIEF;return}}
  }
  if(state===ST.BRIEF)startPlay();
  if(state===ST.DEBRIEF)state=ST.MENU;
  if(state===ST.PAUSE){if(cy>h/2-10&&cy<h/2+30)state=ST.PLAY;if(cy>h/2+32&&cy<h/2+68)state=ST.MENU}
  if(state===ST.PLAY&&cx>w-44&&cy<36)togPause();
}

function procKeys(){
  if(state!==ST.PLAY)return;
  if(keys.ArrowUp)P.throttle=Math.min(1,P.throttle+0.02);
  if(keys.ArrowDown)P.throttle=Math.max(0,P.throttle-0.02);
  P.pi=0;
  if(keys.ArrowRight||tPU)P.pi=1;
  if(keys.ArrowLeft||tPD)P.pi=-1;
}

function startPlay(){
  const m=M[missionIdx];resetPlane(m);
  cam.x=P.x;cam.y=0;bombs=[];expl=[];rolls=0;rollAcc=0;
  objs=m.obj.map(o=>({...o}));curObj=0;objDone=0;gameTime=0;
  tutMsg='';tutTime=0;tutFired={};floats=[];gustF=0;gustT=0;ltTimer=0;turbT=0;
  rain=[];if(m.wx==='storm')for(let i=0;i<120;i++)rain.push({x:Math.random()*2000,y:Math.random()*800});
  state=ST.PLAY;lastTime=performance.now();
}

// ===== DRAWING =====

// -- Sky with horizon glow (original had warm horizon) --
function drawSky(m){
  const w=W(),h=H(),g=ctx.createLinearGradient(0,0,0,h);
  if(m.wx==='night'){
    const np=Math.min(1,P.x/(m.wl*0.5));
    g.addColorStop(0,`rgb(${8+np*-5},${15+np*-10},${40+np*-20})`);
    g.addColorStop(0.7,`rgb(${30-np*15},${50-np*25},${80-np*30})`);
    g.addColorStop(1,`rgb(${60-np*30},${80-np*40},${100-np*40})`);
    ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    if(np>0.2){ctx.fillStyle=`rgba(255,255,255,${np*0.7})`;
      for(let i=0;i<80;i++){const sx=(i*137.5+cam.x*0.01)%w,sy=(i*97.3)%(h*0.5);ctx.fillRect(sx,sy,1.2,1.2)}}
  }else if(m.wx==='storm'){
    g.addColorStop(0,'#3a4a58');g.addColorStop(0.5,'#556672');g.addColorStop(1,'#6a7a86');
    ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
  }else{
    // Classic clear sky with warm horizon glow
    g.addColorStop(0,'#2a5a8c');g.addColorStop(0.45,'#5a9cc8');g.addColorStop(0.75,'#8ec5e0');g.addColorStop(1,'#c8dfc8');
    ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
    // Subtle sun glow
    const sunX=w*0.75,sunY=h*HORIZON*0.3;
    const sg=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,120);
    sg.addColorStop(0,'rgba(255,250,220,0.25)');sg.addColorStop(1,'rgba(255,250,220,0)');
    ctx.fillStyle=sg;ctx.fillRect(sunX-120,sunY-120,240,240);
  }
}

// -- Clouds: puffy, layered, semi-transparent --
function drawClouds(m){
  if(m.wx==='storm')return;
  const isN=m.wx==='night';
  for(let i=0;i<10;i++){
    const cx=((i*480+200)-cam.x*0.08)%(W()+400)-200;
    const cy=20+(i*53)%Math.floor(H()*0.35);
    const s=18+(i*17)%25;
    ctx.fillStyle=isN?'rgba(180,190,210,0.08)':'rgba(255,255,255,0.45)';
    ctx.beginPath();
    ctx.arc(cx,cy,s,0,Math.PI*2);
    ctx.arc(cx+s*0.7,cy-s*0.2,s*0.75,0,Math.PI*2);
    ctx.arc(cx+s*1.3,cy+s*0.05,s*0.6,0,Math.PI*2);
    ctx.arc(cx+s*0.5,cy+s*0.25,s*0.5,0,Math.PI*2);
    ctx.fill();
  }
}

// -- Far mountains: muted blue silhouettes --
function drawFarMtns(m){
  const isN=m.wx==='night';
  ctx.fillStyle=isN?'#0d1a2a':'#4a6a7a';
  ctx.beginPath();ctx.moveTo(0,H());
  // Procedural mountains based on world position
  for(let sx=-50;sx<W()+100;sx+=30){
    const wx=cam.x*0.08+sx*2.5;
    const mh=50+Math.sin(wx*0.004)*35+Math.cos(wx*0.009)*20+Math.sin(wx*0.015)*15;
    ctx.lineTo(sx,H()*HORIZON-mh);
  }
  ctx.lineTo(W(),H());ctx.fill();
  // Snow caps
  if(!isN){
    ctx.fillStyle='rgba(220,230,240,0.3)';
    ctx.beginPath();ctx.moveTo(0,H());
    for(let sx=-50;sx<W()+100;sx+=30){
      const wx=cam.x*0.08+sx*2.5;
      const mh=50+Math.sin(wx*0.004)*35+Math.cos(wx*0.009)*20+Math.sin(wx*0.015)*15;
      const sh=mh>70?mh*0.15:0;
      ctx.lineTo(sx,H()*HORIZON-mh);
      if(sh>0)ctx.lineTo(sx+15,H()*HORIZON-mh+sh);
    }
    ctx.lineTo(W(),H());ctx.fill();
  }
}

// -- Mid hills: green rolling --
function drawMidHills(m){
  const isN=m.wx==='night';
  ctx.fillStyle=isN?'#152815':'#5a7a50';
  ctx.beginPath();ctx.moveTo(0,H());
  for(let sx=-40;sx<W()+80;sx+=25){
    const wx=cam.x*0.25+sx*1.5;
    const hh=25+Math.sin(wx*0.005)*18+Math.cos(wx*0.011)*10;
    ctx.lineTo(sx,H()*HORIZON-hh*0.6);
  }
  ctx.lineTo(W(),H());ctx.fill();
}

// -- Terrain: earth tones with grass detail --
function drawTerrain(m){
  const isN=m.wx==='night',w=W(),h=H();
  // Main terrain fill
  const tg=ctx.createLinearGradient(0,h*HORIZON-20,0,h);
  if(isN){tg.addColorStop(0,'#1a2a15');tg.addColorStop(0.3,'#15200f');tg.addColorStop(1,'#0a0f08')}
  else{tg.addColorStop(0,'#5a8a3a');tg.addColorStop(0.15,'#4a7530');tg.addColorStop(0.4,'#6b5030');tg.addColorStop(1,'#3a2a15')}
  ctx.fillStyle=tg;
  ctx.beginPath();ctx.moveTo(0,h);
  for(const pt of m.terr){const s=w2s(pt.x,pt.y);ctx.lineTo(s.sx,s.sy)}
  ctx.lineTo(w,h);ctx.fill();

  // Grass edge line
  ctx.strokeStyle=isN?'#1a3015':'#3a6520';ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let i=0;i<m.terr.length;i++){const s=w2s(m.terr[i].x,m.terr[i].y);i===0?ctx.moveTo(s.sx,s.sy):ctx.lineTo(s.sx,s.sy)}
  ctx.stroke();

  // Grass tufts along the edge
  if(!isN){
    ctx.fillStyle='#4a8525';
    for(let i=0;i<m.terr.length-1;i++){
      const a=m.terr[i],b=m.terr[i+1];
      const step=Math.max(15,(b.x-a.x)/20);
      for(let wx=a.x;wx<b.x;wx+=step){
        const wy=ghAt(wx,m.terr);
        const s=w2s(wx,wy);
        if(s.sx>-20&&s.sx<w+20){
          ctx.beginPath();ctx.moveTo(s.sx-3,s.sy);ctx.lineTo(s.sx,s.sy-5);ctx.lineTo(s.sx+3,s.sy);ctx.fill();
        }
      }
    }
  }
}

// -- Runway: tarmac with markings, threshold stripes --
function drawRwy(rw,m){
  const l=w2s(rw.x,rw.y),r=w2s(rw.ex,rw.y);
  const rwH=Math.max(10,PPM()*4);
  const isN=m.wx==='night';

  // Tarmac
  ctx.fillStyle=isN?'#2a2a2a':'#555';
  ctx.fillRect(l.sx,l.sy-rwH/2,r.sx-l.sx,rwH);

  // Edge lines
  ctx.strokeStyle='#ccc';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(l.sx,l.sy-rwH/2);ctx.lineTo(r.sx,r.sy-rwH/2);
  ctx.moveTo(l.sx,l.sy+rwH/2);ctx.lineTo(r.sx,r.sy+rwH/2);ctx.stroke();

  // Center dashes
  ctx.strokeStyle='#eee';ctx.lineWidth=1.5;ctx.setLineDash([10,8]);
  ctx.beginPath();ctx.moveTo(l.sx+5,l.sy);ctx.lineTo(r.sx-5,r.sy);ctx.stroke();
  ctx.setLineDash([]);

  // Threshold stripes
  ctx.fillStyle='#ddd';
  for(let i=0;i<4;i++){
    const tx=l.sx+6+i*8,tw=4,th=rwH*0.7;
    ctx.fillRect(tx,l.sy-th/2,tw,th);
    const tx2=r.sx-10-i*8;
    ctx.fillRect(tx2,r.sy-th/2,tw,th);
  }

  // Night lights
  if(isN){ctx.fillStyle='#ffcc00';
    for(let x=rw.x;x<=rw.ex;x+=25){const s=w2s(x,rw.y);ctx.beginPath();ctx.arc(s.sx,s.sy-rwH/2-2,1.8,0,Math.PI*2);ctx.arc(s.sx,s.sy+rwH/2+2,1.8,0,Math.PI*2);ctx.fill()}}
}

// -- World objects --
function drawThings(m){
  if(!m.things)return;
  for(const o of m.things){
    if(o.t==='tgt'){
      const gh=ghAt(o.x,m.terr),s=w2s(o.x,gh);
      ctx.strokeStyle='#ff3333';ctx.lineWidth=2;
      ctx.beginPath();ctx.arc(s.sx,s.sy,o.r*PPM()*0.15,0,Math.PI*2);ctx.stroke();
      ctx.beginPath();ctx.arc(s.sx,s.sy,o.r*PPM()*0.06,0,Math.PI*2);ctx.stroke();
      ctx.beginPath();ctx.moveTo(s.sx-12,s.sy);ctx.lineTo(s.sx+12,s.sy);ctx.moveTo(s.sx,s.sy-12);ctx.lineTo(s.sx,s.sy+12);ctx.stroke();
    }else if(o.t==='city'){
      for(let bx=o.x;bx<o.x+o.w;bx+=20+((bx*7)%12)){
        const bh=12+((bx*11)%30),gh=ghAt(bx,m.terr),s=w2s(bx,gh),bw=14;
        const isN=m.wx==='night';
        ctx.fillStyle=isN?'#1a1a2e':'#6a6a72';
        ctx.fillRect(s.sx-bw/2,s.sy-bh,bw,bh);
        ctx.fillStyle=isN?'rgba(255,230,150,0.5)':'rgba(255,255,230,0.25)';
        for(let wy=s.sy-bh+4;wy<s.sy-2;wy+=8)for(let wx=s.sx-bw/2+2;wx<s.sx+bw/2-2;wx+=5)ctx.fillRect(wx,wy,2.5,3.5);
      }
    }else if(o.t==='water'){
      const l2=w2s(o.x,0),r2=w2s(o.ex,0);
      const isN=m.wx==='night';
      ctx.fillStyle=isN?'rgba(15,30,60,0.7)':'rgba(40,100,180,0.45)';
      ctx.fillRect(l2.sx,l2.sy-3,r2.sx-l2.sx,H()-l2.sy+3);
    }
  }
}

// -- Waypoint marker --
function drawWP(o){
  const s=w2s(o.x,o.y);
  const pulse=1+Math.sin(frameCount*0.1)*0.25;
  ctx.strokeStyle='rgba(255,200,0,0.3)';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.arc(s.sx,s.sy,18*pulse,0,Math.PI*2);ctx.stroke();
  ctx.fillStyle='rgba(255,200,0,0.6)';ctx.strokeStyle='#ffcc00';ctx.lineWidth=1.5;
  ctx.beginPath();ctx.moveTo(s.sx,s.sy-12);ctx.lineTo(s.sx+8,s.sy);ctx.lineTo(s.sx,s.sy+12);ctx.lineTo(s.sx-8,s.sy);ctx.closePath();ctx.fill();ctx.stroke();
}

// -- TU-95 plane: detailed, proportional --
function drawPlane(){
  const s=w2s(P.x,P.y);
  const sc=Math.max(0.65,Math.min(1,W()/700)); // scale plane slightly on tiny screens
  ctx.save();ctx.translate(s.sx,s.sy);ctx.scale(sc,sc);ctx.rotate(-P.pitch);

  // Shadow on ground
  if(P.y<150){
    const gh=ghAt(P.x,M[missionIdx].terr);
    const shadowDist=(P.y-gh)*PPM()/sc;
    ctx.fillStyle='rgba(0,0,0,0.15)';
    ctx.beginPath();ctx.ellipse(0,shadowDist,30,4,0,0,Math.PI*2);ctx.fill();
  }

  // Fuselage
  ctx.fillStyle='#8a9aaa';
  ctx.beginPath();ctx.ellipse(0,0,38,7.5,0,0,Math.PI*2);ctx.fill();
  // Fuselage highlight (top)
  ctx.fillStyle='rgba(200,210,220,0.3)';
  ctx.beginPath();ctx.ellipse(0,-3,34,3,0,0,Math.PI);ctx.fill();
  // Fuselage underside darker
  ctx.fillStyle='rgba(60,70,80,0.2)';
  ctx.beginPath();ctx.ellipse(0,3,34,3,Math.PI,0,Math.PI);ctx.fill();

  // Nose cone
  ctx.fillStyle='#9aacba';
  ctx.beginPath();ctx.moveTo(36,-3);ctx.quadraticCurveTo(50,0,36,3);ctx.fill();
  // Nose tip (glass/radar)
  ctx.fillStyle='#556';
  ctx.beginPath();ctx.arc(46,0,2.5,0,Math.PI*2);ctx.fill();

  // Wings (swept, with thickness)
  ctx.fillStyle='#7a8a98';
  // Top wing
  ctx.beginPath();ctx.moveTo(8,-6);ctx.lineTo(-8,-34);ctx.lineTo(-14,-33);ctx.lineTo(-2,-6);ctx.closePath();ctx.fill();
  // Wing tip detail
  ctx.fillStyle='#b22222';ctx.beginPath();ctx.moveTo(-9,-34);ctx.lineTo(-8,-34);ctx.lineTo(-14,-33);ctx.closePath();ctx.fill();
  // Bottom wing
  ctx.fillStyle='#7a8a98';
  ctx.beginPath();ctx.moveTo(8,6);ctx.lineTo(-8,34);ctx.lineTo(-14,33);ctx.lineTo(-2,6);ctx.closePath();ctx.fill();
  ctx.fillStyle='#b22222';ctx.beginPath();ctx.moveTo(-9,34);ctx.lineTo(-8,34);ctx.lineTo(-14,33);ctx.closePath();ctx.fill();

  // Engines (4 turboprops on wings)
  const engs=[[-5,-17],[-1,-11],[-5,17],[-1,11]];
  engs.forEach(([ex,ey])=>{
    // Nacelle
    ctx.fillStyle='#5a6570';
    ctx.beginPath();ctx.ellipse(ex,ey,4,2.2,0,0,Math.PI*2);ctx.fill();
    // Propeller disc (spinning blur)
    if(P.throttle>0.01){
      ctx.fillStyle=`rgba(200,210,220,${0.15+P.throttle*0.15})`;
      ctx.beginPath();ctx.arc(ex+4,ey,5*Math.min(1,P.throttle*2+0.3),0,Math.PI*2);ctx.fill();
    }
    // Prop lines
    if(P.throttle>0){
      ctx.strokeStyle=`rgba(180,190,200,${0.3+P.throttle*0.3})`;ctx.lineWidth=0.7;
      const a=(performance.now()*P.throttle*0.025)%(Math.PI*2);
      for(let j=0;j<3;j++){const aa=a+j*Math.PI*2/3;
        ctx.beginPath();ctx.moveTo(ex+4+Math.cos(aa)*5.5,ey+Math.sin(aa)*5.5);ctx.lineTo(ex+4-Math.cos(aa)*5.5,ey-Math.sin(aa)*5.5);ctx.stroke()}
    }
  });

  // Tail - vertical stabilizer
  ctx.fillStyle='#7a8a98';
  ctx.beginPath();ctx.moveTo(-33,0);ctx.lineTo(-40,-15);ctx.lineTo(-36,-15);ctx.lineTo(-30,0);ctx.closePath();ctx.fill();
  // Red accent on tail
  ctx.fillStyle='#c03030';
  ctx.beginPath();ctx.moveTo(-39,-15);ctx.lineTo(-40,-15);ctx.lineTo(-37,-8);ctx.lineTo(-36,-8);ctx.closePath();ctx.fill();
  // Horizontal stabilizers
  ctx.fillStyle='#7a8a98';
  ctx.beginPath();ctx.moveTo(-37,-13);ctx.lineTo(-46,-18);ctx.lineTo(-46,-13);ctx.closePath();ctx.fill();
  ctx.beginPath();ctx.moveTo(-37,-13);ctx.lineTo(-46,-8);ctx.lineTo(-46,-13);ctx.closePath();ctx.fill();

  // Cockpit windows
  ctx.fillStyle='#a8d8ea';
  ctx.beginPath();ctx.ellipse(28,-2,5.5,3,-.08,0,Math.PI*2);ctx.fill();
  ctx.strokeStyle='#7ab0c8';ctx.lineWidth=0.5;ctx.stroke();
  // Window divider
  ctx.strokeStyle='#6a90a8';ctx.lineWidth=0.4;
  ctx.beginPath();ctx.moveTo(27,-4.5);ctx.lineTo(27,0);ctx.stroke();

  // Landing gear
  if(P.gear){
    ctx.strokeStyle='#3a3a3a';ctx.lineWidth=1.5;
    // Front
    ctx.beginPath();ctx.moveTo(20,7);ctx.lineTo(20,15);ctx.stroke();
    ctx.fillStyle='#2a2a2a';ctx.beginPath();ctx.arc(20,16,2.8,0,Math.PI*2);ctx.fill();
    // Rear
    ctx.beginPath();ctx.moveTo(-6,7);ctx.lineTo(-6,15);ctx.stroke();
    ctx.beginPath();ctx.arc(-6,16,2.8,0,Math.PI*2);ctx.fill();
  }

  // Red star
  drawStar(-14,-2,3.5);

  // Exhaust shimmer at low throttle
  if(P.throttle>0.3){
    ctx.fillStyle=`rgba(180,160,140,${P.throttle*0.1})`;
    ctx.beginPath();ctx.ellipse(-42,0,P.throttle*12,2,0,0,Math.PI*2);ctx.fill();
  }

  ctx.restore();
}

function drawStar(sx,sy,r){
  ctx.fillStyle='#c03030';ctx.beginPath();
  for(let i=0;i<5;i++){const a=-Math.PI/2+i*2*Math.PI/5,na=a+Math.PI/5;
    ctx.lineTo(sx+Math.cos(a)*r,sy+Math.sin(a)*r);ctx.lineTo(sx+Math.cos(na)*r*0.4,sy+Math.sin(na)*r*0.4)}
  ctx.closePath();ctx.fill();
}

function drawBombs(){ctx.fillStyle='#333';bombs.forEach(b=>{const s=w2s(b.x,b.y);ctx.beginPath();ctx.arc(s.sx,s.sy,3,0,Math.PI*2);ctx.fill()})}

function drawExpl(){
  expl.forEach(e=>{const s=w2s(e.x,e.y),r=(1-e.l)*35+8;
    ctx.fillStyle=`rgba(255,140,30,${e.l*0.8})`;ctx.beginPath();ctx.arc(s.sx,s.sy,r,0,Math.PI*2);ctx.fill();
    ctx.fillStyle=`rgba(255,240,100,${e.l*0.5})`;ctx.beginPath();ctx.arc(s.sx,s.sy,r*0.4,0,Math.PI*2);ctx.fill()});
}

function drawWeather(m,dt){
  if(m.wx==='storm'){
    ctx.fillStyle='rgba(130,140,155,0.22)';ctx.fillRect(0,0,W(),H());
    ctx.strokeStyle='rgba(170,190,210,0.4)';ctx.lineWidth=0.8;
    rain.forEach(r=>{const sx=(r.x-cam.x*0.4+frameCount*2.5)%(W()+200)-100,sy=(r.y+frameCount*4)%(H()+80)-40;
      ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx-2,sy+10);ctx.stroke()});
    ltTimer-=dt;if(ltTimer<=0){ltTimer=8+Math.random()*15;ltFlash=true;setTimeout(()=>{ltFlash=false},80)}
    if(ltFlash){ctx.fillStyle='rgba(255,255,255,0.25)';ctx.fillRect(0,0,W(),H())}
  }
  if(m.wx==='windy'||m.wx==='storm'){gustT-=dt;if(gustT<=0){gustT=2+Math.random()*3;gustF=(Math.random()-0.5)*(m.wx==='storm'?8:4)}gustF*=0.98}
}

function drawFloats(dt){
  floats.forEach(f=>{f.l-=dt;const s=w2s(f.x,f.y+(2-f.l)*20);
    ctx.fillStyle=`rgba(255,255,0,${Math.max(0,f.l/2)})`;ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.fillText(f.txt,s.sx,s.sy)});
  floats=floats.filter(f=>f.l>0);
}

// ===== HUD: compact, instrument-style =====
function drawHUD(m){
  const w=W(),h=H(),p=PPM();
  const fs=Math.max(10,Math.min(12,w*0.016));

  // -- Instrument panel: top-left, compact dark card --
  const panW=Math.min(160,w*0.25),panH=70;
  ctx.fillStyle='rgba(10,15,25,0.7)';
  ctx.beginPath();ctx.roundRect(54,4,panW,panH,5);ctx.fill();
  ctx.strokeStyle='rgba(100,140,180,0.3)';ctx.lineWidth=0.5;ctx.stroke();

  ctx.font=`bold ${fs}px 'Courier New',monospace`;ctx.textAlign='left';
  const alt=Math.floor(P.y*3.28),spd=Math.floor(P.speed*1.94);

  // Alt & Speed
  ctx.fillStyle='#8cf';ctx.fillText('ALT',60,18);
  ctx.fillStyle='#fff';ctx.fillText(`${alt}`,92,18);
  ctx.fillStyle='#8cf';ctx.fillText('SPD',60,32);
  ctx.fillStyle='#fff';ctx.fillText(`${spd}`,92,32);

  // Fuel bar
  ctx.fillStyle='#8cf';ctx.fillText('FUEL',60,46);
  const fuelX=96,fuelW=panW-48;
  ctx.fillStyle='#1a1a1a';ctx.fillRect(fuelX,38,fuelW,8);
  ctx.fillStyle=P.fuel<10&&Math.sin(frameCount*0.2)>0?'#f00':P.fuel>50?'#4a8':P.fuel>25?'#ca4':'#c44';
  ctx.fillRect(fuelX,38,fuelW*P.fuel/100,8);

  // Flaps & Gear on one line
  ctx.fillStyle='#aaa';ctx.font=`${fs-1}px Arial`;
  ctx.fillText(`F:${FLAP_NAMES[P.flaps]}`,60,60);
  ctx.fillStyle=P.gear?'#4a8':'#666';
  ctx.beginPath();ctx.arc(112,56,4,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#aaa';ctx.fillText('G',120,60);
  ctx.fillStyle='#aaa';ctx.fillText(`${Math.floor(P.throttle*100)}%`,140,60);

  // -- Mission info: top-right, subtle --
  const miW=Math.min(180,w*0.3);
  ctx.fillStyle='rgba(10,15,25,0.6)';
  ctx.beginPath();ctx.roundRect(w-miW-6,4,miW,38,5);ctx.fill();
  ctx.fillStyle='#da6';ctx.font=`bold ${fs-1}px Arial`;ctx.textAlign='right';
  ctx.fillText(`M${m.id}: ${m.name.toUpperCase()}`,w-12,17);
  ctx.fillStyle='#bbb';ctx.font=`${fs-1}px Arial`;
  ctx.fillText(curObj<objs.length?objs[curObj].txt:'All objectives complete!',w-12,32);

  // -- Throttle bar: thin strip on left edge --
  const tX=4,tY=20,tW=38,tH=h-60;
  ctx.fillStyle='rgba(10,15,25,0.6)';
  ctx.beginPath();ctx.roundRect(tX,tY,tW,tH,4);ctx.fill();
  // Fill
  const fH=tH*P.throttle;
  const tGrad=ctx.createLinearGradient(0,tY+tH-fH,0,tY+tH);
  tGrad.addColorStop(0,'#4a8');tGrad.addColorStop(0.6,'#ca4');tGrad.addColorStop(1,'#c44');
  ctx.fillStyle=tGrad;
  ctx.beginPath();ctx.roundRect(tX+2,tY+tH-fH,tW-4,fH,3);ctx.fill();
  // Ticks
  ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=0.5;
  for(let i=0;i<=4;i++){const ty=tY+tH*(1-i/4);ctx.beginPath();ctx.moveTo(tX,ty);ctx.lineTo(tX+tW,ty);ctx.stroke()}
  // Label
  ctx.fillStyle='#888';ctx.font='bold 8px Arial';ctx.textAlign='center';
  ctx.fillText('THR',tX+tW/2,tY-3);

  // -- Touch buttons: compact, at bottom edges --
  drawBtns(m);

  // -- Warnings --
  drawWarn(m);

  // -- Tutorial --
  if(tutTime>0&&tutMsg)drawTut();

  // -- Distance/waypoint indicator --
  if(curObj<objs.length){
    const o=objs[curObj];
    if(o.t==='wp'||o.t==='bomb'){
      drawWP(o);
      const dx=o.x-P.x,dist=Math.abs(dx);
      if(dist>80){
        ctx.fillStyle='rgba(255,200,0,0.7)';ctx.font='bold 11px Arial';ctx.textAlign='center';
        ctx.fillText(`${Math.floor(dist)}m \u2192`,w/2,h-90);
      }
    }
  }

  // Pause icon
  ctx.fillStyle='rgba(255,255,255,0.25)';ctx.font='bold 16px Arial';ctx.textAlign='center';
  ctx.fillText('\u23F8',w-22,28);
}

// -- Touch buttons: small, translucent pills --
function drawBtns(m){
  const w=W(),h=H(),pad=6;
  const bS=Math.min(52,h*0.15); // responsive button size

  // Pitch buttons - bottom right
  const puX=w-pad-bS,puY=h-pad-bS;
  const pdX=w-pad-bS*2-4,pdY=puY;

  // Pitch Up
  ctx.fillStyle=tPU?'rgba(70,180,240,0.45)':'rgba(255,255,255,0.1)';
  ctx.beginPath();ctx.roundRect(puX,puY,bS,bS,10);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=0.7;ctx.stroke();
  ctx.fillStyle='#ccc';ctx.font=`bold ${bS*0.35}px Arial`;ctx.textAlign='center';
  ctx.fillText('\u25B2',puX+bS/2,puY+bS*0.5);
  ctx.font=`${Math.max(7,bS*0.15)}px Arial`;ctx.fillText('UP',puX+bS/2,puY+bS*0.78);

  // Pitch Down
  ctx.fillStyle=tPD?'rgba(70,180,240,0.45)':'rgba(255,255,255,0.1)';
  ctx.beginPath();ctx.roundRect(pdX,pdY,bS,bS,10);ctx.fill();
  ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=0.7;ctx.stroke();
  ctx.fillStyle='#ccc';ctx.font=`bold ${bS*0.35}px Arial`;ctx.textAlign='center';
  ctx.fillText('\u25BC',pdX+bS/2,pdY+bS*0.5);
  ctx.font=`${Math.max(7,bS*0.15)}px Arial`;ctx.fillText('DN',pdX+bS/2,pdY+bS*0.78);

  // Utility buttons: bottom-left, small pills
  const sW=Math.min(40,bS*0.78),sH=Math.min(36,bS*0.7);
  const sY=h-pad-sH;
  const btns=[{l:'F',sub:FLAP_NAMES[P.flaps],x:48},{l:'G',sub:P.gear?'DN':'UP',x:48+sW+3}];
  if(m.obj.some(o=>o.t==='bomb'))btns.push({l:'B',sub:'BOMB',x:48+(sW+3)*2});

  btns.forEach(b=>{
    ctx.fillStyle='rgba(255,255,255,0.1)';ctx.beginPath();ctx.roundRect(b.x,sY,sW,sH,6);ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=0.5;ctx.stroke();
    ctx.fillStyle='#bbb';ctx.font=`bold ${Math.max(9,sW*0.28)}px Arial`;ctx.textAlign='center';
    ctx.fillText(b.l,b.x+sW/2,sY+sH*0.42);
    ctx.fillStyle='#da6';ctx.font=`${Math.max(7,sW*0.2)}px Arial`;
    ctx.fillText(b.sub,b.x+sW/2,sY+sH*0.75);
  });
}

function drawWarn(m){
  const spd=P.speed*1.94,w=W(),h=H();
  if(spd<STALL_SPEED*1.94*0.9&&!P.ground&&P.speed>2){
    if(Math.sin(frameCount*0.15)>0){ctx.fillStyle='rgba(255,30,30,0.85)';ctx.font=`bold ${Math.min(22,w*0.04)}px Arial`;ctx.textAlign='center';ctx.fillText('STALL',w/2,h*0.38)}}
  const gh=ghAt(P.x,m.terr);
  if(P.y-gh<20&&!P.ground&&P.vy<0){if(Math.sin(frameCount*0.15)>0){ctx.fillStyle='rgba(255,120,0,0.85)';ctx.font=`bold ${Math.min(20,w*0.035)}px Arial`;ctx.textAlign='center';ctx.fillText('PULL UP',w/2,h*0.44)}}
  if(!P.gear&&!P.ground){
    const ne=Math.abs(P.x-m.er.x)<400&&P.y<100,ns=Math.abs(P.x-m.sr.x)<400&&P.y<100;
    if((ne||ns)&&Math.sin(frameCount*0.1)>0){ctx.fillStyle='rgba(255,200,0,0.85)';ctx.font=`bold ${Math.min(18,w*0.03)}px Arial`;ctx.textAlign='center';ctx.fillText('GEAR!',w/2,h*0.5)}}
}

function drawTut(){
  const w=W(),maxW=Math.min(360,w*0.65);
  ctx.font='13px Arial';ctx.textAlign='center';
  const words=tutMsg.split(' ');const lines=[];let line='';
  for(const wd of words){const test=line+(line?' ':'')+wd;if(ctx.measureText(test).width>maxW-20){lines.push(line);line=wd}else line=test}
  if(line)lines.push(line);
  const lH=17,boxH=lines.length*lH+14,boxW=maxW,bx=(w-boxW)/2,by=50;
  ctx.fillStyle='rgba(0,35,70,0.85)';ctx.beginPath();ctx.roundRect(bx,by,boxW,boxH,6);ctx.fill();
  ctx.strokeStyle='rgba(70,180,240,0.5)';ctx.lineWidth=1;ctx.stroke();
  ctx.fillStyle='#dde';lines.forEach((l,i)=>ctx.fillText(l,w/2,by+14+i*lH));
}

// ===== MENU / BRIEFING / DEBRIEF SCREENS =====
function drawMenu(){
  const w=W(),h=H();
  const g=ctx.createLinearGradient(0,0,0,h);g.addColorStop(0,'#1a1a2e');g.addColorStop(1,'#16213e');
  ctx.fillStyle=g;ctx.fillRect(0,0,w,h);

  ctx.fillStyle='#dde';ctx.strokeStyle='#1e3a5f';ctx.lineWidth=2;
  const ts=Math.min(36,w*0.07);ctx.font=`bold ${ts}px Arial`;ctx.textAlign='center';
  ctx.strokeText('TU-95',w/2,48);ctx.fillText('TU-95',w/2,48);
  ctx.fillStyle='rgba(255,255,255,0.4)';ctx.font=`${Math.min(12,w*0.025)}px Arial`;ctx.fillText('SELECT MISSION',w/2,68);

  // Back
  ctx.fillStyle='rgba(255,255,255,0.12)';ctx.beginPath();ctx.roundRect(8,8,95,28,6);ctx.fill();
  ctx.fillStyle='#aaa';ctx.font='bold 12px Arial';ctx.textAlign='center';ctx.fillText('\u2190 ARCADE',55,27);

  // Mission list
  const lw=260,lx=w/2-lw/2;
  for(let i=0;i<M.length;i++){
    const mi=M[i],ly=88+i*50,unlk=i<prog.u,scored=prog.s[mi.id];
    ctx.fillStyle=unlk?'rgba(255,255,255,0.08)':'rgba(255,255,255,0.02)';
    ctx.beginPath();ctx.roundRect(lx,ly,lw,44,6);ctx.fill();
    if(unlk){ctx.strokeStyle='rgba(70,150,220,0.2)';ctx.lineWidth=0.5;ctx.stroke()}
    ctx.fillStyle=unlk?'#dde':'#445';ctx.font=`bold ${Math.min(14,w*0.028)}px Arial`;ctx.textAlign='left';
    ctx.fillText(`${mi.id}. ${mi.name}`,lx+10,ly+18);
    if(scored){ctx.font='13px Arial';ctx.fillStyle='#da6';
      for(let s=0;s<3;s++)ctx.fillText(s<scored.st?'\u2605':'\u2606',lx+lw-50+s*15,ly+18);
      ctx.fillStyle='#777';ctx.font='10px Arial';ctx.fillText(`${scored.s} pts`,lx+10,ly+34)}
    else if(!unlk){ctx.fillStyle='#445';ctx.font='10px Arial';ctx.textAlign='left';ctx.fillText('LOCKED',lx+10,ly+34)}
    else{ctx.fillStyle='#5ac';ctx.font='10px Arial';ctx.textAlign='left';ctx.fillText('TAP TO PLAY',lx+10,ly+34)}
  }
  ctx.fillStyle='rgba(255,255,255,0.2)';ctx.font='10px Arial';ctx.textAlign='center';
  ctx.fillText('Keys: \u2191\u2193 throttle \u2190\u2192 pitch  F flaps  G gear  B bomb',w/2,h-10);
}

function drawBrief(){
  const w=W(),h=H(),m=M[missionIdx];
  ctx.fillStyle='rgba(0,0,0,0.88)';ctx.fillRect(0,0,w,h);
  const pw=Math.min(380,w*0.82),px=(w-pw)/2,py=h*0.08;
  ctx.fillStyle='rgba(18,28,48,0.95)';ctx.beginPath();ctx.roundRect(px,py,pw,h*0.78,10);ctx.fill();
  ctx.strokeStyle='rgba(70,150,220,0.3)';ctx.lineWidth=0.7;ctx.stroke();

  ctx.fillStyle='#da6';ctx.font=`bold ${Math.min(18,w*0.038)}px Arial`;ctx.textAlign='center';
  ctx.fillText(`MISSION ${m.id}: ${m.name.toUpperCase()}`,w/2,py+30);

  ctx.fillStyle='#bbc';ctx.font=`${Math.min(13,w*0.026)}px Arial`;
  const words=m.brief.split(' ');let lines=[],line='';
  for(const wd of words){const test=line+(line?' ':'')+wd;if(ctx.measureText(test).width>pw-30){lines.push(line);line=wd}else line=test}
  if(line)lines.push(line);
  lines.forEach((l,i)=>ctx.fillText(l,w/2,py+55+i*18));

  const oy=py+60+lines.length*18;
  ctx.fillStyle='#5ac';ctx.font=`bold ${Math.min(12,w*0.024)}px Arial`;ctx.fillText('OBJECTIVES',w/2,oy);
  ctx.fillStyle='#99a';ctx.font=`${Math.min(12,w*0.024)}px Arial`;
  m.obj.forEach((o,i)=>ctx.fillText(`${i+1}. ${o.txt}`,w/2,oy+18+i*16));

  ctx.fillStyle='#667';ctx.font='11px Arial';ctx.fillText(`Weather: ${m.wx.toUpperCase()}`,w/2,oy+24+m.obj.length*16);

  const by=py+h*0.78-42;
  ctx.fillStyle='rgba(70,150,220,0.25)';ctx.beginPath();ctx.roundRect(w/2-50,by,100,32,6);ctx.fill();
  ctx.strokeStyle='#5ac';ctx.lineWidth=0.7;ctx.stroke();
  ctx.fillStyle='#dde';ctx.font='bold 14px Arial';ctx.fillText('START',w/2,by+21);
}

function drawDebrief(){
  const w=W(),h=H(),d=debData;
  ctx.fillStyle='rgba(0,0,0,0.88)';ctx.fillRect(0,0,w,h);
  const pw=Math.min(320,w*0.78),px=(w-pw)/2,py=h*0.06;
  ctx.fillStyle='rgba(18,28,48,0.95)';ctx.beginPath();ctx.roundRect(px,py,pw,h*0.84,10);ctx.fill();

  ctx.fillStyle=d.ok?'#4a8':'#c44';ctx.font=`bold ${Math.min(20,w*0.042)}px Arial`;ctx.textAlign='center';
  ctx.fillText(d.ok?'MISSION COMPLETE':'MISSION FAILED',w/2,py+30);

  if(d.ok){ctx.font='24px Arial';for(let i=0;i<3;i++){ctx.fillStyle=i<d.st?'#da6':'#334';ctx.fillText(i<d.st?'\u2605':'\u2606',w/2-24+i*24,py+56)}}

  let sy=py+(d.ok?78:55);
  const rows=[];if(d.ok)rows.push(['Mission Complete','+1000']);
  rows.push(['Objectives',`${objDone}\u00d7200 = ${objDone*200}`]);
  if(d.ok){rows.push(['Fuel Bonus',`+${d.fb}`]);rows.push(['Time Bonus',`+${d.tb}`]);rows.push(['Landing',`+${d.lb}`])}
  if(d.rb>0)rows.push(['Barrel Rolls',`+${d.rb}`]);

  ctx.font=`${Math.min(12,w*0.025)}px Arial`;
  rows.forEach(([l,v])=>{ctx.fillStyle='#889';ctx.textAlign='left';ctx.fillText(l,px+20,sy);ctx.fillStyle='#dde';ctx.textAlign='right';ctx.fillText(v,px+pw-20,sy);sy+=20});

  sy+=6;ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(px+20,sy-10);ctx.lineTo(px+pw-20,sy-10);ctx.stroke();
  ctx.fillStyle='#da6';ctx.font=`bold ${Math.min(16,w*0.034)}px Arial`;ctx.textAlign='left';ctx.fillText('TOTAL',px+20,sy);ctx.textAlign='right';ctx.fillText(`${d.s}`,px+pw-20,sy);

  const by=py+h*0.84-40;
  ctx.fillStyle='rgba(70,150,220,0.25)';ctx.beginPath();ctx.roundRect(w/2-50,by,100,30,6);ctx.fill();
  ctx.strokeStyle='#5ac';ctx.lineWidth=0.7;ctx.stroke();
  ctx.fillStyle='#dde';ctx.font='bold 13px Arial';ctx.textAlign='center';ctx.fillText('CONTINUE',w/2,by+20);
}

function drawPause(){
  const w=W(),h=H();
  ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#dde';ctx.font=`bold ${Math.min(28,w*0.05)}px Arial`;ctx.textAlign='center';ctx.fillText('PAUSED',w/2,h/2-25);
  ctx.fillStyle='rgba(255,255,255,0.15)';ctx.beginPath();ctx.roundRect(w/2-50,h/2,100,28,6);ctx.fill();
  ctx.fillStyle='#dde';ctx.font='bold 13px Arial';ctx.fillText('RESUME',w/2,h/2+19);
  ctx.fillStyle='rgba(255,255,255,0.08)';ctx.beginPath();ctx.roundRect(w/2-50,h/2+36,100,28,6);ctx.fill();
  ctx.fillStyle='#889';ctx.fillText('QUIT',w/2,h/2+55);
}

// ===== LOOP =====
function update(dt){
  frameCount++;const m=M[missionIdx];
  if(state===ST.PLAY){
    gameTime+=dt;procKeys();physics(dt,m);checkObj(m);if(m.tut)checkTut(m);
    const lx=Math.min(1,8*dt),ly=Math.min(1,5*dt);
    cam.x+=(P.x+P.vx*0.8-cam.x)*lx;cam.y+=(P.y*0.7-cam.y)*ly;
    if(tutTime>0)tutTime-=dt;
  }
  // Tick explosions in both PLAY and CRASH states
  if(state===ST.PLAY||state===ST.CRASH){
    expl.forEach(e=>{e.l-=dt});expl=expl.filter(e=>e.l>0);
  }
}

function render(){
  const m=M[missionIdx];
  if(state===ST.MENU){drawMenu();return}
  if(state===ST.BRIEF){drawBrief();return}
  if(state===ST.DEBRIEF){drawDebrief();return}

  // Game world
  drawSky(m);drawClouds(m);drawFarMtns(m);drawMidHills(m);drawTerrain(m);
  drawRwy(m.sr,m);drawRwy(m.er,m);drawThings(m);drawBombs();drawExpl();
  if(state!==ST.CRASH&&curObj<objs.length){const o=objs[curObj];if(o.t==='wp'||o.t==='bomb')drawWP(o)}
  if(!P.crashed)drawPlane();
  const dt=1/60;drawWeather(m,dt);drawFloats(dt);drawHUD(m);
  if(state===ST.CRASH){
    const cw=W(),ch=H();
    ctx.fillStyle='rgba(200,30,0,0.15)';ctx.fillRect(0,0,cw,ch);
    if(Math.sin(frameCount*0.15)>0){
      ctx.fillStyle='rgba(255,60,30,0.9)';ctx.font=`bold ${Math.min(28,cw*0.05)}px Arial`;
      ctx.textAlign='center';ctx.fillText('CRASHED!',cw/2,ch*0.4);
    }
  }
  if(state===ST.PAUSE)drawPause();
}

function loop(now){
  const dt=lastTime?Math.min((now-lastTime)/1000,0.05):1/60;lastTime=now;
  update(dt);render();requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
